<!--
	コードが稚拙なのは許してや、城之内・・・
　　　,,,,,,,､､､､,,,,,,,
　　（ﾐﾐﾐｼYﾐｼ,彡）
　　|f''　　''''　 ''ヾ|
　　|ﾐ ,,,,,,､　,,,,,,, ﾐ|
　　}|´立）　 立｀|{
　 （'l　 　, i ､　　l'）
　 　l 　 ' ｀_´,丶l
　　 ﾄ　 .´ニ　' ｲ
　 　| . ＼ー／　＼
-->
<!DOCTYPE html>
<html lang="ja">
<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>顔認証団</title>
	<meta property="og:title" content="顔認証団">
	<meta property="og:type" content="article">
	<meta property="og:image" content="https://utzmie.github.io/sunglasses-tracking/ogp.jpg">
	<meta property="og:url" content="https://utzmie.github.io/sunglasses-tracking/">
	<meta property="og:description" content="グラサンジェネレータ">
	<meta property="og:site_name" content="顔認証団">
	<meta property="og:locale" content="ja_JP">
	<meta name="twitter:card" content="summary">
	<meta name="twitter:title" content="顔認証団">
	<meta name="twitter:description" content="グラサンジェネレータ">
	<meta name="twitter:image" content="https://utzmie.github.io/sunglasses-tracking/ogp.jpg">
	<link rel="stylesheet" href="./style.css">
	<style>

		/* サングラス */
		.sunglasses {
			left: -10%;
			top: -800px;
			width: 120%;
		}
		.is-active .sunglasses {
			top: 18% !important;
		}
		.is-active .border {
			border-color: transparent;
		}

	</style>
	<!-- Google Tag Manager -->
	<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
	new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
	j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
	'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
	})(window,document,'script','dataLayer','GTM-WKMH9W');</script>
	<!-- End Google Tag Manager -->
</head>
<body>
	<!-- Google Tag Manager (noscript) -->
	<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-WKMH9W"
	height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
	<!-- End Google Tag Manager (noscript) -->
	<div class="container">
		<h1>顔認証団</h1>

		<div id="face">
			<div id="js-loading-container" class="loading-container">
				<div class="loading"></div>
				<span>Loading</span>
			</div>
			<div class="image-container">
				
				<img id="target-image" src="img/photo-chiaki.jpg" alt="">

			</div><!-- /image-container -->
		</div><!-- /face -->

		<!-- output error -->
		<div id="result" class="result-container"></div>

		<div id="face-list" class="face-list">
			<button class="face-list__item" id="face-list-1" style="background-image:url(./img/photo-20161224-2315.jpg);">
				<img src="./img/photo-20161224-2315.jpg" alt="">
			</button>
			<button class="face-list__item" id="face-list-2" style="background-image:url(./img/photo-hiyama.jpg);">
				<img src="./img/photo-hiyama.jpg" alt="">
			</button>
			<button class="face-list__item" id="face-list-3" style="background-image:url(./img/photo-two.jpg);">
				<img src="./img/photo-two.jpg" alt="">
			</button>
			<button class="face-list__item" id="face-list-4" style="background-image:url(./img/photo-shinji.jpg);">
				<img src="./img/photo-shinji.jpg" alt="">
			</button>
		</div>

		<!-- button -->
		<div class="button-container" style="text-align: center;">
			<button disabled="disabled" type="button" class="button" id="start" style="min-width: 6em;">重ねろ！</button>
			<p style="font-size: 12px;">※音が出ます</p>
		</div>

		<p class="input-container">
			<input type="file" id="file_upload" name="file_upload" accept="image/*">
			<button class="button" type="submit" id="submit_upload" name="submit_upload">変更</button>
		</p>
		<p style="text-align: center; font-size: 12px;">※好きな画像を選んで「変更」→「重ねろ！」ボタンを押してね！<br>
			（画像はサーバーにアップロードされたりしません。安心してお使いください。）</p>

		<style>
			.input-container {
				display: -webkit-flex;
				display: -moz-flex;
				display: -ms-flex;
				display: flex;
				align-items: flex-start;
			}
			.input-container input[type="file"] {
				width: 100%;
				border: 3px solid #ddd;
				padding: 1.25em 1em;
				cursor: pointer;
				box-sizing: border-box;
				margin-right: 1em;
				font-size: 12px;
			}
			.input-container input[type="file"]:hover {
				border-color: #E8A1A8;
			}
			.input-container button {
				width: auto;
				margin: 0;	
			}
		</style>



		<h2>注釈（多くてごめん）</h2>
		<ul>
			<li><strong>画像の解像度が大きいと<span style="font-size: 24px;">クッソ時間がかかる</span>ので要注意。</strong></li>
			<li>画像にによって精度がかなり変わる（認識できない画像も多い）。</li>
			<li>一方で、複数人（10人とか）でも認識できたりする。</li>
			<li>ブラウザによって認識が変わることがある。</li>
			<li>ごく稀にLoadingが消えなくなるので、そのときはリロードで。</li>
			<li>目の位置を判定してるわけじゃないからズレることがある。
				<ul>
					<li>顔があまりに傾いてたりしたらたぶん無理。</li>
					<li>赤い枠内の、上から18%くらいの位置を指定したら、だいたい目のあたりに置かれるようになったけど、人によってパーツの位置が違うから仕方ないね。</li>
				</ul>
			</li>
			<li>顔認識には<a href="https://github.com/jaysalvat/jquery.facedetection" target="_blank">jquery.facedetection</a>というライブラリを使っているので、認識の性能自体についてはワシは何もできない。</li>
		</ul>

		<audio id="audio">
			<source src="sound.mp3">
		</audio>

	</div><!-- /container -->


	<script src="./jquery-2.2.4.min.js"></script> 
	<script src="./jquery.facedetection/jquery.facedetection.min.js"></script>
	<script>

		!function($) {

			var $loading_container = $('#js-loading-container'); // Loading...
			var $face_container    = $('#face'); // 画像コンテナ
			var $target_image      = $('#target-image'); // 重ねる画像（1枚）
			var $sunglasses        = $('.sunglasses'); // サングラス（人数分）
			var button             = $('#start');
			var audio              = $('#audio').get(0);
			var isError;


			// hide Loading...
			window.onload = function() {
				tracking();
				$loading_container.hide();

				if ( ! isError ) {
					button.attr('disabled', false);
				}
			}


			// button click event
			
			button.on('click', function() {

				// 適用する
				if ( ! isCollageActive() ) {
					playCollage();

				// 戻す
				} else {
					stopCollage();
				}

			});

			// コラが適用中かどうかチェック
			function isCollageActive() {
				return $face_container.hasClass('is-active');
			}


			// コラ適用 ＆ サウンド再生
			function playCollage() {
				button.text('戻す');
				$face_container.addClass('is-active');
				$sunglasses.removeClass('is-hidden');

				if ( !isSoundPlaying(audio) ) {
					playSound();
				}
			}
			// コラ削除 ＆ サウンド停止
			function stopCollage() {
				button.text('重ねろ！');
				$face_container.removeClass('is-active');
				$sunglasses.addClass('is-hidden');

				if ( isSoundPlaying(audio) ) {
					stopSound();
				}
			}


			// サウンド再生
			function playSound() {
				audio.play();
			}
			// サウンド停止
			function stopSound() {
				audio.pause();
				audio.currentTime = 0;
			}
			// // サウンドが再生中かどうかチェック
			function isSoundPlaying(sound) {
				return !sound.paused;
			}


			// エラーメッセージ
			function errorMessage() {
				$('#result').show();
				$('#result').text("顔が認識できませんでした");
			}


			// tracking face
			function tracking() {

				$target_image.faceDetection({

					// success
					complete: function (faces) {

						console.log(faces);

						// reset
						$("[id^=position]").remove();
						

						if ( faces.length > 0 ) {

							// remove loading
							$loading_container.hide();

							button.attr('disabled', false);
							$('#result').hide().text('');

							// 人数分
							for ( var i=0 ; i < faces.length ; i++ ) {

								console.log ("face: " + i);
								console.log ( "x: "         + faces[i].x + 'px');
								console.log ( "y: "         + faces[i].y + 'px');
								console.log ( "positionX: " + faces[i].positionX + 'px');
								console.log ( "positionY: " + faces[i].positionY + 'px');
								console.log ( "off-x: "     + faces[i].offsetX + 'px' + '(parent)' );
								console.log ( "off-y: "     + faces[i].offsetY + 'px' + '(parent)' );
								console.log ( "scale-x: "   + faces[i].scaleX );
								console.log ( "scale-y: "   + faces[i].scaleY );


								var $face_position = $('<div id="position' + i + '"></div>');
									$face_position.appendTo($face_container);

								// create Frame
								var $border = $('<div>');
									$border.addClass('border');
									$border.appendTo( '#position' + i );

								// clear Img into box
								var $sunglasses = $('<img>');
									$sunglasses.attr('id', 'sunglasses' + i);
									$sunglasses.attr('src', './sunglasses.png');
									$sunglasses.addClass('sunglasses');
									$sunglasses.appendTo( '#position' + i + ' > ' + '.border' );

								// Frame (box)
								$('#position' + i).children('.border').css({
									left:   faces[i].positionX * faces[i].scaleX + "px" ,
									top:    faces[i].positionY * faces[i].scaleY + "px" ,
									width:  faces[i].width  * faces[i].scaleX + "px" ,
									height: faces[i].height * faces[i].scaleY + "px"
								});

								var image_height = $target_image.height();
								$('.sunglasses').css({
									top: -(image_height)
								});
							}
						}

						// not have
						else {
							$loading_container.hide();
							errorMessage();
							button.attr('disabled', 'disabled');
							isError = true;
						}
					},

					// error
					error: function (code, message) {
						$loading_container.hide();
						errorMessage();
						button.attr('disabled', 'disabled');
						isError = true;

						$("[id^=position]").remove();
					}
				});
			};


			// ファイルアップロード（ローカル）
			var file   = document.getElementById('file_upload');
			var submit = document.getElementById('submit_upload');
			
			submit.addEventListener('click', function(e) {

				stopCollage();

				var image_data = file.files[0];

				if ( image_data ) {
					$loading_container.show();
				}

				fileReader = new FileReader();
				fileReader.readAsDataURL(image_data);

				fileReader.onload = function(event) {
					var image_data_uri = event.target.result;
					$target_image.attr('src', image_data_uri);

					tracking();
				};

			});


			// サムネイルをクリックしたら差し替え
			var face_list = document.getElementById('face-list');

			for (var i = 0; i < face_list.children.length; i++){
				var item = face_list.children[i];
				item.addEventListener('click', function(e) {

					stopCollage();
					var thumbSrc = $(this).children().attr('src');
					$target_image.attr('src', thumbSrc);
					tracking();

				});
			}

		}(jQuery);

</script>  
</body>
</html>